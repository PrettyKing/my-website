---
title: Docker 镜像打包和发布基本流程
date: 2021-03-06
tags:
 - tools
categories:
 - 流程
---

## 创建一个简易的项目

- 目录结构如下

  ```js
  .
  ├── .dockerignore
  ├── Dockerfile
  ├── node_modules
  ├── package-lock.json // 必须有，否则在docker push时会警告
  ├── package.json
  ├── server.js
  └── yarn.lock
  ```

- server.js

  ```js
  const Koa = require('koa');
  const app = new Koa();
  app.use(async ctx => {
     ctx.body = 'Hello docker';
  });
  app.listen(3000);
  ```

- Package.json

  ```json
  {
      "name": "docker_demo",
      "version": "1.0.0",
      "description": "docker build test", // 必须有，否则在docker push时会警告
      "main": "index.js",
      "scripts": {
          "start": "node server.js"
      },
      "keywords": [],
      "author": "",
      "license": "ISC",
      "dependencies": {
          "koa": "^2.13.1"
      },
      "repository": { // 必须有，否则在docker push时会警告
          "type": "git",
          "url": "http://github.com"
      }
  }
  ```

- .dockerignore

  ```shell
  # Logs
  logs
  *.log
  npm-debug.log*
  # Runtime data
  pids
  *.pid
  *.seed
  # Directory for instrumented libs generated by jscoverage/JSCover
  lib-cov
  # Coverage directory used by tools like istanbul
  # Logs
  logs
  *.log
  npm-debug.log*
  # Runtime data
  pids
  *.pid
  *.seed
  # Directory for instrumented libs generated by jscoverage/JSCover
  lib-cov
  # Coverage directory used by tools like istanbul
  ```

- Dockerfile

  ```js
  #制定node镜像的版本
  FROM node:8.9-alpine
  #声明作者
  MAINTAINER chalee 
  #移动当前⽬目录下⾯面的⽂文件到app⽬目录下 
  ADD . /app/ 
  #进⼊入到app⽬目录下⾯面，类似cd 
  WORKDIR /app
  #安装依赖
  RUN npm install
  #对外暴暴露露的端⼝口
  EXPOSE 3000
  #程序启动脚本
  CMD ["npm", "start"]
  ```

## 打包镜像

```shell
# 构建镜像
docker build -t docker_demo .
# 运行镜像
docker run -d -p 9000:3000 docker_demo
# 查看镜像
docker ps 
# 删除镜像
docker rmi 镜像ID
# 删除运行的镜像 （必须先停止镜像）
docker rm 镜像ID
```

## 发布镜像

``` shell
# 登录docker hub (需要root权限)
sudo docker login
# 给镜像打tag （发布时需要）766c9b622783-> 镜像ID chaleechen->docker用户名 镜像名称
docker tag 766c9b622783 chaleechen/docker_demo
# 发布镜像
sudo docker push chaleechen/docker_demo:latest
# https://hub.docker.com/repositories 查看仓库就会发现刚刚打包好的镜像

# 查看自己发布的镜像
docker search chaleechen/docker_demo
# 拉取自己发布的镜像
docker pull chaleechen/docker_demo
```

